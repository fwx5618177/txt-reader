name: Multi-Platform Build

on:
  push:
    branches:
      - main
      - uat
      - dev
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - uat
      - dev

env:
  name: "TXT-Reader"

jobs:
  # Windows 构建任务：只编译 Windows 应用
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 安装 yq
      - name: Install yq
        run: choco install yq

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows

          # 重命名生成的 exe 文件
      - name: Rename executable
        run: |
            move build\windows\x64\runner\Release\txt_reader.exe build\windows\x64\runner\Release\${{ env.name }}.exe

      - name: Upload Windows Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build\windows\x64\runner\Release\${{ env.name }}.exe

  # macOS 构建任务
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      # 编译 macOS
      - name: Build macOS
        run: flutter build macos --release

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG file
        run: |
          mkdir -p build/macos/dmg
          create-dmg \
            --volname "${{ env.name }}" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "runner.app" 200 190 \
            --app-drop-link 600 185 \
            "build/macos/Build/Products/Release/txt_reader.app" \
            "build/macos/dmg/${{ env.name }}.dmg"

      # 上传 macOS 构建产物
      - name: Upload macOS Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/macos/dmg/${{ env.name }}.dmg

    # iOS 构建任务
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      # 编译 iOS
      - name: Build iOS
        run: flutter build ios --no-codesign

      # 安装 fastlane 并导出 ipa
      - name: Install Fastlane
        run: sudo gem install fastlane

      # 使用 fastlane 导出 IPA 文件
      - name: Create IPA File
        run: |
            mkdir -p build/ios/ipa
            fastlane gym --scheme "Runner" --export_method "development" --output_directory "./build/ios/ipa" --output_name ${{ env.name }}.ipa --xcargs "CODE_SIGNING_ALLOWED=NO"

      # 上传 iOS 构建产物
      - name: Upload iOS Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/ipa/*.ipa

    # Android 构建任务
  build-android:
    runs-on: macos-latest
    steps:
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      # 编译 Android
      - name: Build Android
        run: flutter build apk

      - name: Rename APK
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/${{ env.name }}.apk

      # 上传 Android 构建产物
      - name: Upload Android Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: build/app/outputs/flutter-apk/${{ env.name }}.apk
    
  # Linux 构建任务：只编译 Linux 应用
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq using snap
        run: sudo snap install yq

      - name: Install dependencies for Linux build
        run: sudo apt-get install -y cmake ninja-build gcc g++ libgtk-3-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux

      - name: Rename executable
        run: |
          mv build/linux/x64/release/bundle/txt_reader build/linux/x64/release/bundle/${{ env.name }}

      - name: Upload Linux Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/linux/x64/release/bundle/${{ env.name }}